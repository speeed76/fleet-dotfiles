# ── Fleet Dotfiles — tmux.conf ───────────────────────────────────────────────
# Compatible with tmux 3.2+ (all fleet machines target 3.4+)
# Repo: https://github.com/speeed76/fleet-dotfiles

# ── Prefix ───────────────────────────────────────────────────────────────────
unbind C-b
set -g prefix C-a
bind C-a send-prefix          # Ctrl+a twice = send literal Ctrl+a

# ── Core behaviour ───────────────────────────────────────────────────────────
set  -g default-terminal "tmux-256color"
set  -ga terminal-overrides ",*256col*:Tc"   # true colour
set  -ga terminal-overrides "*:RGB"
set  -g escape-time 0           # no lag after Esc (critical for vim inside tmux)
set  -g repeat-time 300
set  -g history-limit 50000
set  -g buffer-limit 20
set  -g display-time 1500
set  -g focus-events on          # let vim/nvim react to focus
set  -g mouse on
set  -g base-index 1             # windows start at 1
set  -g pane-base-index 1
set  -g renumber-windows on      # fill gaps when window closed
set  -g set-clipboard on
setw -g mode-keys vi
setw -g automatic-rename on
setw -g aggressive-resize on

# ── Reload config ────────────────────────────────────────────────────────────
bind r source-file ~/.tmux.conf \; display "tmux.conf reloaded"

# ── Splits — open in current directory ───────────────────────────────────────
unbind '"'
unbind %
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window      -c "#{pane_current_path}"

# ── Pane navigation (vi-style, no prefix needed via C-h/j/k/l) ───────────────
# Smart pane switching — works transparently with vim/nvim (vim-tmux-navigator)
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"
bind -n C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"
# Fallback with prefix
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# ── Pane resize (repeatable) ─────────────────────────────────────────────────
bind -r H resize-pane -L 3
bind -r J resize-pane -D 3
bind -r K resize-pane -U 3
bind -r L resize-pane -R 3
bind -r M-h resize-pane -L 10
bind -r M-l resize-pane -R 10

# ── Window navigation ────────────────────────────────────────────────────────
bind -n M-h previous-window     # Alt+h/l to switch windows
bind -n M-l next-window
bind -r p previous-window
bind -r n next-window
bind Tab last-window            # quick toggle to last active window

# ── Session management ───────────────────────────────────────────────────────
bind S choose-session
bind N new-session
bind X confirm-before -p "Kill session '#S'? (y/n)" kill-session

# ── Copy mode (vi) ───────────────────────────────────────────────────────────
bind Enter copy-mode
bind -T copy-mode-vi v      send -X begin-selection
bind -T copy-mode-vi V      send -X select-line
bind -T copy-mode-vi C-v    send -X rectangle-toggle
bind -T copy-mode-vi y      send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi H      send -X start-of-line
bind -T copy-mode-vi L      send -X end-of-line
# Search in copy mode
bind -T copy-mode-vi / command-prompt -p "search:" "send -X search-forward '%%%'"
bind p paste-buffer

# ── Misc ─────────────────────────────────────────────────────────────────────
bind m set -g mouse \; display "Mouse #{?mouse,on,off}"   # toggle mouse
bind e setw synchronize-panes \; display "Sync #{?pane_synchronized,on,off}"
bind q display-panes           # show pane numbers
bind z resize-pane -Z          # zoom/unzoom current pane
bind ! break-pane              # break pane into its own window
bind @ join-pane -t :-1        # pull pane from previous window

# ── Catppuccin Mocha theme ───────────────────────────────────────────────────
# Colours matching catppuccin mocha palette (consistent with vim/nvim)
# Base: #1e1e2e  Surface: #313244  Overlay: #585b70
# Text: #cdd6f4  Subtext: #a6adc8  Rosewater: #f5e0dc
# Blue: #89b4fa  Lavender: #b4befe  Green: #a6e3a1
# Yellow: #f9e2af  Red: #f38ba8   Peach: #fab387

# ─ Pane borders
set -g pane-border-style        "fg=#313244"
set -g pane-active-border-style "fg=#89b4fa"

# ─ Status bar
set -g status on
set -g status-position bottom
set -g status-justify left
set -g status-interval 5
set -g status-style "bg=#1e1e2e,fg=#cdd6f4"

# ─ Left: session name
set -g status-left-length 30
set -g status-left "#[bg=#89b4fa,fg=#1e1e2e,bold] #S #[bg=#1e1e2e,fg=#89b4fa]"

# ─ Right: host · date · time
set -g status-right-length 80
set -g status-right \
  "#[fg=#585b70] #[fg=#a6adc8]#{?pane_synchronized,#[fg=#f38ba8]SYNC ,}"\
  "#[fg=#585b70]│ #[fg=#a6adc8]%a %d %b #[fg=#585b70]│ #[fg=#cdd6f4,bold]%H:%M "\
  "#[bg=#89b4fa,fg=#1e1e2e,bold] #h "

# ─ Window tabs
setw -g window-status-style          "bg=#1e1e2e,fg=#585b70"
setw -g window-status-format         " #I:#W "
setw -g window-status-current-style  "bg=#313244,fg=#89b4fa,bold"
setw -g window-status-current-format " #I:#W#{?window_zoomed_flag, 󰍉,} "
setw -g window-status-activity-style "bg=#1e1e2e,fg=#f9e2af"

# ─ Message / command prompt
set -g message-style         "bg=#313244,fg=#cdd6f4"
set -g message-command-style "bg=#313244,fg=#89b4fa"

# ─ Mode (copy mode highlight)
setw -g mode-style "bg=#585b70,fg=#cdd6f4"

# ── Plugins (TPM) ────────────────────────────────────────────────────────────
# Install TPM: git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'          # clipboard copy in copy mode
set -g @plugin 'tmux-plugins/tmux-resurrect'      # save/restore sessions
set -g @plugin 'tmux-plugins/tmux-continuum'      # auto-save sessions

# ─ resurrect / continuum config
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-strategy-vim  'session'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# ─ yank config
set -g @yank_selection_mouse 'clipboard'
set -g @yank_action 'copy-pipe-no-clear'

# Bootstrap TPM silently (works on first install)
if "test ! -d ~/.tmux/plugins/tpm" \
  "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# ── Load TPM (keep at bottom) ─────────────────────────────────────────────────
run '~/.tmux/plugins/tpm/tpm'
# ────────────────────────────────────────────────────────────────────────────
