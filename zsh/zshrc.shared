# ── Fleet Dotfiles — zshrc.shared ──────────────────────────────────────────
# Sourced by all fleet machines. Machine-specific config goes in ~/.zshrc.local
# Repo: https://github.com/speeed76/fleet-dotfiles

# ── Modern tool aliases (gracefully degrade if binary not present) ──────────
if command -v eza &>/dev/null; then
  alias ls='eza --icons --color=auto --group-directories-first'
  alias ll='eza -la --icons --git --group-directories-first'
  alias lt='eza --tree --level=2 --icons'
  alias lta='eza --tree --level=3 --icons --all'
else
  alias ls='ls --color=auto 2>/dev/null || ls -G'
  alias ll='ls -la'
fi

if command -v bat &>/dev/null; then
  alias cat='bat --paging=never'
  alias less='bat'
elif command -v batcat &>/dev/null; then
  alias cat='batcat --paging=never'
  alias less='batcat'
fi

command -v fd  &>/dev/null && alias find='fd'
command -v rg  &>/dev/null && alias grep='rg'
command -v htop &>/dev/null && alias top='htop'
command -v dust &>/dev/null && alias du='dust'

# ── Navigation ──────────────────────────────────────────────────────────────
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias ~='cd ~'

# ── Git ─────────────────────────────────────────────────────────────────────
alias g='git'
alias gs='git status -sb'
alias ga='git add'
alias gaa='git add -A'
alias gc='git commit'
alias gcm='git commit -m'
alias gca='git commit --amend --no-edit'
alias gp='git push'
alias gpl='git pull --rebase'
alias gl='git log --oneline --graph --decorate -20'
alias gla='git log --oneline --graph --decorate --all -20'
alias gd='git diff'
alias gds='git diff --staged'
alias gco='git checkout'
alias gsw='git switch'
alias gb='git branch'
alias gba='git branch -a'
alias gst='git stash'
alias gstp='git stash pop'
alias grb='git rebase'
alias grs='git restore'
alias grh='git reset --hard'

# ── Docker ──────────────────────────────────────────────────────────────────
if command -v docker &>/dev/null; then
  alias d='docker'
  alias dc='docker compose'
  alias dps='docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'
  alias dlog='docker logs -f'
  alias dexec='docker exec -it'
  alias dclean='docker system prune -f'
fi

# ── System ──────────────────────────────────────────────────────────────────
alias df='df -h'
alias mkdir='mkdir -pv'
alias ports='ss -tlnp 2>/dev/null || netstat -tlnp 2>/dev/null || lsof -i -P | grep LISTEN'
alias reload='exec zsh'
alias path='echo "$PATH" | tr ":" "\n" | nl'
alias sshconfig='${EDITOR:-vim} ~/.ssh/config'
alias hosts='${EDITOR:-vim} /etc/hosts'
alias myip='curl -s ifconfig.me'
alias localip='ipconfig getifaddr en0 2>/dev/null || hostname -I | awk "{print \$1}"'

# ── Safety nets ─────────────────────────────────────────────────────────────
alias cp='cp -iv'
alias mv='mv -iv'
alias rm='rm -iv'

# ── Editor ──────────────────────────────────────────────────────────────────
if command -v nvim &>/dev/null; then
  alias vim='nvim'
  alias vi='nvim'
  export EDITOR='nvim'
  export VISUAL='nvim'
else
  export EDITOR='vim'
  export VISUAL='vim'
fi

# ── FZF ─────────────────────────────────────────────────────────────────────
export FZF_DEFAULT_OPTS='--height=40% --layout=reverse --border --inline-info'
if command -v fd &>/dev/null; then
  export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
  export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
fi
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# ── Zoxide (smart cd) ───────────────────────────────────────────────────────
if command -v zoxide &>/dev/null; then
  eval "$(zoxide init zsh --cmd cd)"
fi

# ── History ─────────────────────────────────────────────────────────────────
HISTSIZE=50000
SAVEHIST=50000
HISTFILE=~/.zsh_history
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt SHARE_HISTORY
setopt EXTENDED_HISTORY

# ── GCP fleet-agent-sa helper ───────────────────────────────────────────────
if command -v gcloud &>/dev/null && [ -f "$HOME/.secrets/fleet-agent-sa.json" ]; then
  _gcp_secret() {
    GOOGLE_APPLICATION_CREDENTIALS="$HOME/.secrets/fleet-agent-sa.json" \
      gcloud secrets versions access latest \
        --secret "$1" \
        --project thebigword-calendar 2>/dev/null
  }
  use-api-claude() {
    local key
    key=$(_gcp_secret ANTHROPIC_API_KEY) \
      || { echo "[claude] ERROR: could not read ANTHROPIC_API_KEY"; return 1; }
    export ANTHROPIC_API_KEY="$key"
    export CLAUDE_CONTEXT="api"
    echo "[claude] API billing active"
  }
  use-sub-claude() {
    unset ANTHROPIC_API_KEY
    export CLAUDE_CONTEXT="sub"
    echo "[claude] OAuth subscription active"
  }
  _claude_rprompt() {
    case "$CLAUDE_CONTEXT" in
      api) RPROMPT="%F{yellow}[claude:api]%f" ;;
      sub) RPROMPT="%F{green}[claude:sub]%f" ;;
      *)   RPROMPT="" ;;
    esac
  }
  precmd_functions+=(_claude_rprompt)
fi

# ── Machine-local overrides (last — wins over shared) ───────────────────────
[ -f ~/.zshrc.local ] && source ~/.zshrc.local
# ───────────────────────────────────────────────────────────────────────────
